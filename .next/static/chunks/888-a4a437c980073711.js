"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[888],{6888:(e,t,a)=>{a.d(t,{A:()=>c,AuthProvider:()=>d});var r=a(95155),l=a(12115),s=a(77139),i=a(63259),n=a(51287);let o=l.createContext(null);function u(e){var t;return{id:e.id,name:e.name,email:e.email,role:e.role,mustChangePassword:null!==(t=e.must_change_password)&&void 0!==t&&t}}function d(e){var t,a,d,c,m,f;let{children:_}=e,[h,g]=l.useState(null),[w,v]=l.useState(!1),[p,y]=l.useState(null),[S,E]=l.useState([]),[C,b]=l.useState(null),[I,q]=l.useState(""),[x,k]=l.useState(""),[P,A]=l.useState(!1),N=l.useMemo(()=>(0,i.A)(),[]),L=l.useCallback(e=>{var t,a,r,l,s;if(!(null==e?void 0:e.user)){b(null),q(""),k(""),A(!1),y(null);return}b(e.user.id),q(null!==(l=null!==(r=null===(t=e.user.user_metadata)||void 0===t?void 0:t.name)&&void 0!==r?r:e.user.email)&&void 0!==l?l:""),k(null!==(s=e.user.email)&&void 0!==s?s:""),A((null===(a=e.user.user_metadata)||void 0===a?void 0:a.must_change_password)===!0),(0,n.CH)(N,e.user.id).then(e=>{e?y(u(e)):y(null)})},[N]);l.useEffect(()=>{if(!N){g((0,s.iT)()),v(!0);return}let e=!1;N.auth.getSession().then(t=>{let{data:{session:a}}=t;e||(v(!0),L(a))});let{data:{subscription:t}}=N.auth.onAuthStateChange((t,a)=>{e||L(a)});return(0,n.lR)(N).then(t=>{e||E(t.map(u))}),()=>{e=!0,t.unsubscribe()}},[N,L]);let T=l.useCallback(async()=>{N&&E((await (0,n.lR)(N)).map(u))},[N]),U=l.useCallback(e=>{if(N)return;let t=(0,s.lo)().find(t=>t.id===e);t&&(0,s.mc)(t.role),(0,s.cq)(e),g(e)},[N]),J=l.useCallback(()=>{if(N){N.auth.signOut(),y(null);return}(0,s.ri)(),g(null)},[N]),M=l.useCallback(e=>{(0,s.mc)(e)},[]),O=!!N,G=O?S:[],R=O?null!==(t=null!=C?C:null==p?void 0:p.id)&&void 0!==t?t:null:w?(0,s.iT)():h,j={id:"",name:"",email:"",role:"student",mustChangePassword:!1},B=R?O?(null==p?void 0:p.id)===R?p:C===R?{id:R,name:I||"\xc9l\xe8ve",email:x,role:"student",mustChangePassword:P}:null!==(d=null!==(a=S.find(e=>e.id===R))&&void 0!==a?a:S[0])&&void 0!==d?d:j:null!==(c=(0,s.lo)().find(e=>e.id===R))&&void 0!==c?c:j:j,H={...B,mustChangePassword:null!==(m=B.mustChangePassword)&&void 0!==m?m:P},K=null!==(f=null==H?void 0:H.role)&&void 0!==f?f:"student",D=!!R&&w,Q=l.useMemo(()=>({user:H,role:K,isLoggedIn:D,setRole:M,login:U,logout:J,allUsers:G,refetchProfiles:T,useSupabase:O}),[H,K,D,M,U,J,G,T,O]);return(0,r.jsx)(o.Provider,{value:Q,children:_})}function c(){let e=l.useContext(o);if(!e)throw Error("useAuth must be used within AuthProvider");return e}},77139:(e,t,a)=>{a.d(t,{QF:()=>v,cq:()=>m,iT:()=>c,jw:()=>p,lo:()=>h,mc:()=>d,ri:()=>f});let r=[{id:"1",name:"Admin SVT",email:"admin@svt-lycee.fr",role:"admin"},{id:"2",name:"Marie Dupont",email:"marie.dupont@svt-lycee.fr",role:"teacher"},{id:"3",name:"Lucas Martin",email:"lucas.martin@svt-lycee.fr",role:"student"},{id:"4",name:"Emma Bernard",email:"emma.bernard@svt-lycee.fr",role:"student"},{id:"5",name:"Hugo Petit",email:"hugo.petit@svt-lycee.fr",role:"student"},{id:"6",name:"L\xe9a Moreau",email:"lea.moreau@svt-lycee.fr",role:"student"}],l=(r[0],r[1],r[2],"svt-users"),s="svt-passwords",i="svt-auth-role",n="svt-auth-user-id",o="svt-auth-logged-in",u="eleve123";function d(e){localStorage.setItem(i,e)}function c(){return localStorage.getItem(n)}function m(e){localStorage.setItem(n,e),localStorage.setItem(o,"true")}function f(){localStorage.removeItem(n),localStorage.removeItem(o),localStorage.removeItem(i)}function _(){try{let e=localStorage.getItem(l);if(!e)return r;return JSON.parse(e)}catch(e){return r}}function h(){return _()}function g(){try{let e=localStorage.getItem(s);if(!e)return{};return JSON.parse(e)}catch(e){return{}}}function w(e){localStorage.setItem(s,JSON.stringify(e))}function v(e,t){!function(){let e=_(),t=g(),a=!1;for(let r of e){let e=r.email.toLowerCase();t[e]||(t[e]="student"===r.role?u:"demo",a=!0)}a&&w(t)}();let a=_(),r=g(),l=e.trim().toLowerCase(),s=a.find(e=>e.email.toLowerCase()===l);if(!s)return null;let i=r[l];return i&&i===t.trim()?s:null}function p(e,t){var a;let r=_(),s=t.trim().toLowerCase();if(r.some(e=>e.email.toLowerCase()===s))throw Error("Un utilisateur avec cet email existe d\xe9j\xe0.");let i={id:"s-"+Date.now(),name:e.trim(),email:t.trim(),role:"student"};return a=[...r,i],localStorage.setItem(l,JSON.stringify(a)),!function(e,t){let a=g();a[e.trim().toLowerCase()]=t,w(a)}(i.email,u),i}},51287:(e,t,a)=>{async function r(e){let{data:t,error:a}=await e.from("classes").select("id, name").order("name");if(a)throw Error(a.message);let r=null!=t?t:[];if(0===r.length)return[];let l=r.map(e=>e.id),{data:s,error:i}=await e.from("class_students").select("class_id, user_id").in("class_id",l);if(i)throw Error(i.message);let n=new Map;for(let e of l)n.set(e,[]);for(let e of null!=s?s:[]){let t=n.get(e.class_id);t&&t.push(e.user_id)}return r.map(e=>{var t;return{id:e.id,name:e.name,studentIds:null!==(t=n.get(e.id))&&void 0!==t?t:[]}})}async function l(e,t,a){let{data:r,error:l}=await e.from("classes").insert({name:t,created_by:a}).select("id, name").single();if(l)throw Error(l.message);return{id:r.id,name:r.name,studentIds:[]}}async function s(e,t,a){let{error:r}=await e.from("classes").update({name:a}).eq("id",t);if(r)throw Error(r.message)}async function i(e,t){let{error:a}=await e.from("classes").delete().eq("id",t);if(a)throw Error(a.message)}async function n(e,t){let{data:a,error:r}=await e.from("class_students").select("user_id").eq("class_id",t);if(r)throw Error(r.message);let l=(null!=a?a:[]).map(e=>e.user_id);if(0===l.length)return[];let{data:s,error:i}=await e.from("profiles").select("id, name, email").in("id",l);if(i)throw Error(i.message);return(null!=s?s:[]).map(e=>({id:e.id,name:e.name,email:e.email}))}async function o(e,t,a){let{error:r}=await e.from("class_students").insert({class_id:t,user_id:a});if(r)throw Error(r.message)}async function u(e,t,a){let{error:r}=await e.from("class_students").delete().eq("class_id",t).eq("user_id",a);if(r)throw Error(r.message)}function d(e){var t;return{studentId:e.student_id,examName:e.exam_name,note:e.note,date:e.date,coefficient:null!==(t=e.coefficient)&&void 0!==t?t:void 0}}async function c(e,t){let{data:a,error:r}=await e.from("grades").select("student_id, exam_name, note, date, coefficient").eq("class_id",t);if(r)throw Error(r.message);return(null!=a?a:[]).map(d)}async function m(e,t,a){if(0===a.length)return;let r=a.map(e=>{var a;return{class_id:t,student_id:e.studentId,exam_name:e.examName,note:e.note,date:e.date,coefficient:null!==(a=e.coefficient)&&void 0!==a?a:null}}),{error:l}=await e.from("grades").upsert(r,{onConflict:"class_id,student_id,exam_name"});if(l)throw Error(l.message)}function f(e,t){return"".concat(t,"/storage/v1/object/public/corrections/").concat(e)}async function _(e,t){let a=e.from("corrections").select("id, title, class_id, file_path, file_name, uploaded_at");(null==t?void 0:t.classId)!==void 0&&null!==t.classId&&(a=a.eq("class_id",t.classId));let{data:r,error:l}=await a.order("uploaded_at",{ascending:!1});if(l)throw Error(l.message);return(null!=r?r:[]).map(e=>({id:e.id,title:e.title,classId:e.class_id,fileUrl:f(e.file_path,"https://ycxwrlkqfoiokmogxlfd.supabase.co"),filePath:e.file_path,fileName:e.file_name,uploadedAt:e.uploaded_at}))}async function h(e,t){let{data:a,error:r}=await e.from("corrections").insert({title:t.title,class_id:t.classId,file_path:t.filePath,file_name:t.fileName,uploaded_by:t.uploadedBy}).select("id, title, class_id, file_path, file_name, uploaded_at").single();if(r)throw Error(r.message);return{id:a.id,title:a.title,classId:a.class_id,fileUrl:f(a.file_path,"https://ycxwrlkqfoiokmogxlfd.supabase.co"),filePath:a.file_path,fileName:a.file_name,uploadedAt:a.uploaded_at}}async function g(e,t){let{error:a}=await e.from("corrections").delete().eq("id",t);if(a)throw Error(a.message)}async function w(e,t){let{error:a}=await e.storage.from("corrections").remove([t]);if(a)throw Error(a.message)}a.d(t,{CH:()=>E,GH:()=>h,Gd:()=>w,KT:()=>l,Sy:()=>m,Yh:()=>o,eJ:()=>s,lR:()=>S,n0:()=>n,se:()=>_,us:()=>c,vK:()=>r,w$:()=>g,w4:()=>u,wt:()=>i});let v="id, name, email, role, must_change_password",p="id, name, email, role";function y(e){var t;let a=null!==(t=null==e?void 0:e.message)&&void 0!==t?t:"";return a.includes("must_change_password")||a.includes("column")&&a.includes("does not exist")}async function S(e,t){let a=e.from("profiles").select(v);t&&(a=a.eq("role",t));let{data:r,error:l}=await a.order("name");if(l&&y(l)){var s;a=e.from("profiles").select(p),t&&(a=a.eq("role",t));let r=await a.order("name");if(r.error)throw Error(r.error.message);return(null!==(s=r.data)&&void 0!==s?s:[]).map(e=>({...e,must_change_password:!1}))}if(l)throw Error(l.message);return(null!=r?r:[]).map(e=>{var t;return{...e,must_change_password:null!==(t=e.must_change_password)&&void 0!==t&&t}})}async function E(e,t){var a;let{data:r,error:l}=await e.from("profiles").select(v).eq("id",t).single();if(l&&y(l)){let a=await e.from("profiles").select(p).eq("id",t).single();if(a.error&&"PGRST116"!==a.error.code)throw Error(a.error.message);return a.data?{...a.data,must_change_password:!1}:null}if(l&&"PGRST116"!==l.code)throw Error(l.message);return r?{...r,must_change_password:null!==(a=r.must_change_password)&&void 0!==a&&a}:null}},63259:(e,t,a)=>{a.d(t,{A:()=>i});var r=a(95352),l=a(2818);let s=null;function i(){var e;let t="https://ycxwrlkqfoiokmogxlfd.supabase.co",a=null!==(e=l.env.NEXT_PUBLIC_SUPABASE_ANON_KEY)&&void 0!==e?e:"sb_publishable_Ciw05QM2VyvN8U5gbrkJKA_GlJl-yA0";return t&&a?(s||(s=(0,r.UU)(t,a)),s):null}}}]);